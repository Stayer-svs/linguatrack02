<!-- app_vocab/templates/app_vocab/multiple_choice.html -->
{% extends "app_vocab/base.html" %}

{% block title %}–¢–µ—Å—Ç —Å –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞{% endblock %}

{% block extra_css %}
<style>
    .test-container {
        max-width: 600px;
        margin: 0 auto;
        text-align: center;
    }
    .question {
        font-size: 1.5em;
        font-weight: bold;
        margin: 30px 0;
        color: #333;
    }
    .options-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin: 30px 0;
    }
    .option-btn {
        padding: 15px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        font-size: 1.1em;
        transition: all 0.3s ease;
    }
    .option-btn:hover {
        border-color: #2196F3;
        background: #f8f9fa;
    }
    .option-btn.selected {
        border-color: #4CAF50;
        background: #e8f5e8;
    }
    .submit-btn {
        padding: 12px 30px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1.1em;
        cursor: pointer;
        margin-top: 20px;
    }
    .submit-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }
    .submit-btn:hover:not(:disabled) {
        background: #45a049;
    }
    .no-words {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    .test-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .navigation-links {
        margin-top: 30px;
    }
    .navigation-links a {
        margin: 0 10px;
        color: #2196F3;
        text-decoration: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <h1>üéØ –¢–µ—Å—Ç —Å –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞</h1>

    {% if no_words_message %}
        <div class="no-words">
            <h3>üìù –ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <p>{{ no_words_message }}</p>
            <div class="navigation-links">
                <a href="/">‚û°Ô∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ</a>
            </div>
        </div>
    {% else %}
        <div class="test-info">
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è —Å–ª–æ–≤–∞:</p>
        </div>

        <div class="question">
            "{{ question_word.word.original }}"
            {% if question_word.word.transcription %}
                <br><small style="color: #666;">[{{ question_word.word.transcription }}]</small>
            {% endif %}
        </div>

        <form method="post" action="{% url 'app_vocab:check-answer' %}" id="test-form">
            {% csrf_token %}
            <input type="hidden" name="correct_answer" value="{{ correct_answer_id }}">
            <input type="hidden" name="question_word_id" value="{{ question_word.id }}">
            <input type="hidden" name="selected_answer" id="selected-answer" value="">

            <div class="options-grid">
                {% for option in options %}
                    <button type="button"
                            class="option-btn"
                            data-answer-id="{{ option.id }}"
                            onclick="selectAnswer({{ option.id }}, this)">
                        {{ option.translation }}
                    </button>
                {% endfor %}
            </div>

            <button type="submit" class="submit-btn" id="submit-btn" disabled>
                ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
            </button>
        </form>

        <div class="navigation-links">
            <a href="/">üéì –û–±—ã—á–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</a>
            <a href="{% url 'app_vocab:multiple_choice_test' %}">üîÑ –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedAnswerId = null;

    window.selectAnswer = function(answerId, button) {
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        button.classList.add('selected');
        selectedAnswerId = answerId;
        document.getElementById('selected-answer').value = answerId;
        document.getElementById('submit-btn').disabled = false;
    };

    document.getElementById('test-form').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!selectedAnswerId) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç');
            return;
        }

        const formData = new FormData(this);
        formData.append('user_answer', selectedAnswerId);
        formData.append('correct_answer', document.querySelector('input[name="correct_answer"]').value);

        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:');
        for (let [key, value] of formData.entries()) {
            console.log(key + ': ' + value);
        }

        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            if (data.error) {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
                return;
            }
            showTestResult(data);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ—Ç–≤–µ—Ç–∞');
        });
    });

    function showTestResult(data) {
        let resultHtml = '';

        if (data.correct) {
            resultHtml = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 3em;">‚úÖ</div>
                    <h3 style="color: #4CAF50;">${data.message}</h3>
                    <p><strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong> ${data.correct_answer}</p>
                </div>
            `;
        } else {
            resultHtml = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 3em;">‚ùå</div>
                    <h3 style="color: #f44336;">${data.message}</h3>
                    <p><strong>–í–∞—à –æ—Ç–≤–µ—Ç:</strong> ${data.user_answer || '–Ω–µ –≤—ã–±—Ä–∞–Ω'}</p>
                    <p><strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong> ${data.correct_answer}</p>
                </div>
            `;
        }

        document.querySelector('.container').innerHTML = resultHtml + `
            <div style="text-align: center; margin-top: 30px;">
                <a href="{% url 'app_vocab:multiple_choice_test' %}" class="nav-link" style="display: inline-block; margin: 0 10px;">
                    üîÑ –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
                </a>
                <a href="{% url 'app_vocab:word_list' %}" class="nav-link" style="display: inline-block; margin: 0 10px;">
                    üéì –û–±—ã—á–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
                </a>
            </div>
        `;
    }
});
</script>
{% endblock %}
