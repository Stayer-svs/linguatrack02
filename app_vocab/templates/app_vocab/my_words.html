<!-- app_vocab/templates/app_vocab/my_words.html -->
{% extends "app_vocab/base.html" %}

{% block title %}–ú–æ–π –°–ª–æ–≤–∞—Ä—å{% endblock %}

{% block extra_css %}
<style>
    .words-container {
        max-width: 1000px;
        margin: 0 auto;
    }
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #4CAF50;
    }
    .stat-number {
        font-size: 1.5em;
        font-weight: bold;
        color: #333;
    }
    .stat-label {
        color: #666;
        font-size: 0.9em;
    }
    .actions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 30px 0 20px 0;
    }
    .add-btn {
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        text-decoration: none;
        font-size: 1em;
    }
    .add-btn:hover {
        background: #45a049;
    }
    .words-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .words-table th,
    .words-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }
    .words-table th {
        background: #343a40;
        color: white;
        font-weight: bold;
    }
    .words-table tr:hover {
        background: #f8f9fa;
    }
    .delete-btn {
        background: #f44336;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }
    .delete-btn:hover {
        background: #d32f2f;
    }
    .no-words {
        text-align: center;
        padding: 40px;
        color: #666;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .knowledge-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
    }
    .badge-new { background: #ffeb3b; color: #333; }  /* –∂–µ–ª—Ç—ã–π */
    .badge-beginner { background: #2196F3; color: white; }  /* —Å–∏–Ω–∏–π */
    .badge-practicing { background: #FF9800; color: white; } /* –æ—Ä–∞–Ω–∂–µ–≤—ã–π */
    .badge-learned { background: #4CAF50; color: white; }  /* –∑–µ–ª–µ–Ω—ã–π */
    .messages {
        margin: 20px 0;
    }
    .alert {
        padding: 12px 15px;
        border-radius: 6px;
        margin: 10px 0;
    }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    .sort-btn {
    padding: 6px 12px;
    margin: 0 2px;
    background: #f8f9fa;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9em;
}
.sort-btn:hover {
    background: #e9ecef;
}
.sort-btn.active {
    background: #2196F3;
    color: white;
    border-color: #2196F3;
}
</style>
{% endblock %}

{% block content %}
<div class="words-container">
    <h1>üìö –ú–æ–π –°–ª–æ–≤–∞—Ä—å</h1>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-number">{{ words_stats.total }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ —Å–ª–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ words_stats.new }}</div>
            <div class="stat-label">–ù–æ–≤—ã–µ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ words_stats.learning }}</div>
            <div class="stat-label">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ words_stats.learned }}</div>
            <div class="stat-label">–ò–∑—É—á–µ–Ω–æ</div>
        </div>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
    <div class="actions-header">
        <h2>–°–ø–∏—Å–æ–∫ —Å–ª–æ–≤</h2>
        <div>
            <span style="margin-right: 10px;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</span>
            <a href="?sort=date_added" class="sort-btn {% if current_sort == 'date_added' %}active{% endif %}">üìÖ –ü–æ –¥–∞—Ç–µ</a>
            <a href="?sort=original" class="sort-btn {% if current_sort == 'original' %}active{% endif %}">üî§ –ü–æ —Å–ª–æ–≤—É</a>
            <a href="?sort=level" class="sort-btn {% if current_sort == 'level' %}active{% endif %}">üéØ –ü–æ —É—Ä–æ–≤–Ω—é</a>
            <a href="?sort=next_review" class="sort-btn {% if current_sort == 'next_review' %}active{% endif %}">üìÜ –ü–æ –¥–∞—Ç–µ –ø–æ–≤—Ç–æ—Ä–∞</a>
            <a href="{% url 'app_vocab:add_word' %}" class="add-btn">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ
            </a>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å–ª–æ–≤ -->
    {% if user_words %}

        <table class="words-table">
            <thead>
                <tr>
                    <th>–°–ª–æ–≤–æ</th>
                    <th>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</th>
                    <th>–ü–µ—Ä–µ–≤–æ–¥</th>
                    <th>–£—Ä–æ–≤–µ–Ω—å</th>
                    <th>–°–ª–µ–¥—É—é—â–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</th>  <!-- –ò–ó–ú–ï–ù–ò–¢–¨ –ù–ê–ó–í–ê–ù–ò–ï -->
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user_word in user_words %}
                <tr>
                    <td><strong>{{ user_word.word.original }}</strong></td>
                    <td>
                        {% if user_word.word.transcription %}
                            [{{ user_word.word.transcription }}]
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>{{ user_word.word.translation }}</td>
                    <td>
                        <span class="knowledge-badge
                            {% if user_word.repetition == 0 %}badge-new
                            {% elif user_word.repetition == 1 %}badge-beginner
                            {% elif user_word.repetition <= 3 %}badge-practicing
                            {% else %}badge-learned{% endif %}">
                            {{ user_word.get_knowledge_level }}
                        </span>
                    </td>
                    <td style="text-align: center;">

                        <!-- –ö–ù–û–ü–ö–ê "–°–ï–ô–ß–ê–°" -->
                        <div style="margin-bottom: 5px;">
                            {{ user_word.next_review|date:"d.m.Y" }}
                        </div>
                        <!-- –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–µ–π—á–∞—Å" —á–µ—Ä–µ–∑ AJAX (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã) -->
                        <button type="button"
                                class="btn review-now-btn"
                                style="background: #ff9800; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;"
                                data-word-id="{{ user_word.id }}"
                                onclick="reviewNow(this)">
                            üïê –°–µ–π—á–∞—Å
                        </button>

                    </td>

                    <td>
                        <!-- –ö–ù–û–ü–ö–ê –£–î–ê–õ–ï–ù–ò–Ø -->
                        <form method="post" action="{% url 'app_vocab:remove_word' user_word.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="delete-btn"
                                    onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ &quot;{{ user_word.word.original }}&quot; –∏–∑ –≤–∞—à–µ–≥–æ —Å–ª–æ–≤–∞—Ä—è?')">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}

                <script>
                function reviewNow(button) {
                    const wordId = button.dataset.wordId;
                    const originalText = button.textContent;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                    button.textContent = '‚è≥...';
                    button.disabled = true;

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
                    fetch(`/my-words/review-now/${wordId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                            const dateCell = button.parentElement;
                            dateCell.querySelector('div').textContent = new Date().toLocaleDateString('ru-RU');

                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                            button.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ!';
                            setTimeout(() => {
                                button.textContent = 'üïê –°–µ–π—á–∞—Å';
                                button.disabled = false;
                            }, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞:', error);
                        button.textContent = '‚ùå –û—à–∏–±–∫–∞';
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.disabled = false;
                        }, 1000);
                    });
                }
                </script>
            </tbody>
        </table>

    {% else %}
        <div class="no-words">
            <h3>üìù –í–∞—à —Å–ª–æ–≤–∞—Ä—å –ø—É—Å—Ç</h3>
            <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è!</p>
            <a href="{% url 'app_vocab:add_word' %}" class="add-btn" style="display: inline-block; margin-top: 15px;">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}