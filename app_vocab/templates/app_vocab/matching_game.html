<!-- app_vocab/templates/app_vocab/matching_game.html -->
{% extends "app_vocab/base.html" %}

{% block title %}–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤{% endblock %}

{% block extra_css %}
<style>
    .matching-container {
        max-width: 900px;
        margin: 0 auto;
        text-align: center;
    }
    .game-instructions {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #2196F3;
    }
    .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 30px 0;
        max-height: 60vh;
        overflow-y: auto;
        padding: 10px;
    }
    .word-card {
        background: white;
        padding: 20px;
        border: 3px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        user-select: none;
        transition: all 0.3s ease;
        font-size: 1.1em;
        font-weight: bold;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    .word-card:hover {
        border-color: #2196F3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .word-card.selected {
        border-color: #2196F3;
        background: #e3f2fd;
    }
    .word-card.correct {
        border-color: #4CAF50;
        background: #e8f5e8;
    }
    .word-card.incorrect {
        border-color: #f44336;
        background: #ffebee;
    }
    .word-card.matched {
        border-color: #4CAF50;
        background: #c8e6c9;
        cursor: default;
        opacity: 0.7;
    }
    .progress-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        font-size: 1.2em;
    }
    .navigation-links {
        margin-top: 30px;
    }
    .navigation-links a {
        margin: 0 10px;
        color: #2196F3;
        text-decoration: none;
        padding: 10px 20px;
        border: 2px solid #2196F3;
        border-radius: 6px;
        display: inline-block;
    }
    .navigation-links a:hover {
        background: #2196F3;
        color: white;
    }
    .no-words {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    .game-stats {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 20px 0;
        font-size: 1.1em;
    }
    .stat-item {
        background: #f8f9fa;
        padding: 10px 20px;
        border-radius: 20px;
        border: 2px solid #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="matching-container">
    <h1>üéÆ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–≤</h1>

    {% if no_words_message %}
        <div class="no-words">
            <h3>üìù –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–ª–æ–≤</h3>
            <p>{{ no_words_message }}</p>
            <div class="navigation-links">
                <a href="{% url 'app_vocab:my_words' %}">üìí –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞</a>
                <a href="/">üìñ –û–±—ã—á–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</a>
            </div>
        </div>
    {% else %}
        <div class="game-instructions">
            <p>üéØ <strong>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ, –∑–∞—Ç–µ–º –Ω–∞ –µ–≥–æ –ø–µ—Ä–µ–≤–æ–¥</strong></p>
            <p>‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä—ã –≤—ã–¥–µ–ª—è—é—Ç—Å—è –∑–µ–ª–µ–Ω—ã–º, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ ‚Äî –∫—Ä–∞—Å–Ω—ã–º</p>
            <p>üèÜ –°–æ–±–µ—Ä–∏—Ç–µ –≤—Å–µ –ø–∞—Ä—ã —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É!</p>
        </div>

        <div class="game-stats">
            <div class="stat-item">
                üìä –ù–∞–π–¥–µ–Ω–æ: <span id="matched-count">0</span>/<span id="total-pairs">{{ total_pairs }}</span>
            </div>
            <div class="stat-item">
                ‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: <span id="remaining-count">{{ total_pairs }}</span>
            </div>
        </div>

        <div class="cards-grid" id="cards-container">
            {% for pair in word_pairs %}
                <div class="word-card"
                     data-type="original"
                     data-pair-id="{{ pair.id }}"
                     data-value="{{ pair.original }}"
                     onclick="selectCard(this)">
                    {{ pair.original }}
                    {% if pair.transcription %}
                        <br><small style="font-size: 0.8em; color: #666;">[{{ pair.transcription }}]</small>
                    {% endif %}
                </div>
                <div class="word-card"
                     data-type="translation"
                     data-pair-id="{{ pair.id }}"
                     data-value="{{ pair.translation }}"
                     onclick="selectCard(this)">
                    {{ pair.translation }}
                </div>
            {% endfor %}
        </div>

        <div class="navigation-links">
            <a href="/">üìñ –û–±—ã—á–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</a>
            <a href="{% url 'app_vocab:multiple_choice_test' %}">üîò –¢–µ—Å—Ç —Å –≤—ã–±–æ—Ä–æ–º</a>
            <a href="{% url 'app_vocab:matching_game' %}">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedCard = null;
    let matchedPairs = new Set();
    const totalPairs = {{ total_pairs }};

    function selectCard(card) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —É–∂–µ —Å–æ–≤–ø–∞–≤—à–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
        if (card.classList.contains('matched')) {
            return;
        }

        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ (–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–∞—Ä—ã)
        if (selectedCard && !selectedCard.isSecondClick) {
            selectedCard.classList.remove('selected');
            selectedCard.isSecondClick = false;
        }

        // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –≤ –ø–∞—Ä–µ
        if (!selectedCard || selectedCard.isSecondClick) {
            card.classList.add('selected');
            selectedCard = card;
            selectedCard.isSecondClick = false;
            return;
        }

        // –ï—Å–ª–∏ —ç—Ç–æ –≤—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –≤ –ø–∞—Ä–µ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        const firstCard = selectedCard;
        const secondCard = card;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞—é—Ç –ª–∏ pair-id
        if (firstCard.dataset.pairId === secondCard.dataset.pairId &&
            firstCard.dataset.type !== secondCard.dataset.type) {

            // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–∞—Ä–∞!
            firstCard.classList.remove('selected');
            firstCard.classList.add('correct');
            secondCard.classList.add('correct');

            setTimeout(() => {
                firstCard.classList.add('matched');
                secondCard.classList.add('matched');
                firstCard.classList.remove('correct');
                secondCard.classList.remove('correct');

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                matchedPairs.add(firstCard.dataset.pairId);
                updateGameStats();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
                if (matchedPairs.size === totalPairs) {
                    setTimeout(() => {
                        alert(`üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –Ω–∞—à–ª–∏ –≤—Å–µ ${totalPairs} –ø–∞—Ä!`);
                    }, 500);
                }
            }, 1000);

        } else {
            // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–∞—Ä–∞
            firstCard.classList.add('incorrect');
            secondCard.classList.add('incorrect');

            setTimeout(() => {
                firstCard.classList.remove('selected', 'incorrect');
                secondCard.classList.remove('incorrect');
            }, 1000);
        }

        selectedCard = null;
    }

    function updateGameStats() {
        document.getElementById('matched-count').textContent = matchedPairs.size;
        document.getElementById('remaining-count').textContent = totalPairs - matchedPairs.size;
    }

    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('cards-container');
        const cards = Array.from(container.children);

        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç–æ—á–µ–∫
        for (let i = cards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            container.appendChild(cards[j]);
        }
    });
</script>
{% endblock %}