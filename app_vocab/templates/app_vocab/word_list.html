{% extends "app_vocab/base.html" %}

{% block title %}–¢—Ä–µ–Ω–∞–∂–µ—Ä —Å–ª–æ–≤{% endblock %}

{% block extra_css %}
<style>
    .stats-bar {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
    }
    .stats-bar span {
        margin: 0 10px;
        font-size: 0.9em;
    }
    .controls {
        text-align: center;
        margin-bottom: 20px;
    }
    .reverse-btn {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
    }
    .reverse-btn:hover {
        background-color: #45a049;
    }
    .word-card {
        border: 1px solid #ddd;
        padding: 15px;
        margin: 15px auto;
        border-radius: 8px;
        max-width: 500px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        font-weight: bold;
        font-size: 1.4em;
        text-align: center;
        margin-bottom: 10px;
    }
    .transcription {
        text-align: center;
        font-style: italic;
        color: #666;
        margin-bottom: 10px;
    }
    .answer {
        text-align: center;
        font-size: 1.2em;
        color: #2E7D32;
        margin: 15px 0;
        display: none;
    }
    .action-buttons {
        text-align: center;
    }
    .btn {
        padding: 8px 16px;
        margin: 0 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .show-btn {
        background-color: #2196F3;
        color: white;
    }
    .know-btn {
        background-color: #4CAF50;
        color: white;
    }
    .dont-know-btn {
        background-color: #f44336;
        color: white;
    }
    .btn:hover {
        opacity: 0.9;
    }
    .progress-info {
        text-align: center;
        font-size: 0.8em;
        color: #999;
        margin-top: 10px;
    }
    .no-words {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
    }
    .tts-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2em;
        margin-left: 10px;
        padding: 5px;
        border-radius: 50%;
        transition: background-color 0.3s;
    }
    .tts-btn:hover {
        background-color: #f0f0f0;
    }
</style>
{% endblock %}

{% block content %}
<h1>üéì –¢—Ä–µ–Ω–∞–∂–µ—Ä (SRS)</h1>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-bar">
    <span>üìä –í—Å–µ–≥–æ —Å–ª–æ–≤: {{ statistics.total }}</span>
    <span>üÜï –ù–æ–≤—ã–µ: {{ statistics.new }}</span>
    <span>üìö –í –ø—Ä–æ—Ü–µ—Å—Å–µ: {{ statistics.learning }}</span>
    <span>‚úÖ –ò–∑—É—á–µ–Ω–æ: {{ statistics.learned }}</span>
    <span>üéØ –ù–∞ —Å–µ–≥–æ–¥–Ω—è: {{ statistics.today }}</span>
</div>

<!-- –î–Ω–µ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã -->
<div class="stats-bar">
    <span>üìÖ –î–Ω–µ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã: üîÑ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π: {{ profile.daily_review_limit }}/ üÜï –ù–æ–≤—ã—Ö —Å–ª–æ–≤: {{ profile.daily_new_words }}</span>
</div>

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
<div class="controls">
    <button class="reverse-btn" onclick="location.href='?reverse={% if is_reverse %}0{% else %}1{% endif %}'">
        {% if is_reverse %}üîÅ –° —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π{% else %}üîÅ –° –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π{% endif %}
    </button>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è -->
{% if user_words %}
    {% for user_word in user_words %}
        <div class="word-card" id="word-{{ user_word.id }}">
            <div class="word-header">
                <div class="word-text">
                    <span class="word-original">
                        {% if is_reverse %}
                            {{ user_word.word.translation }}
                        {% else %}
                            {{ user_word.word.original }}
                        {% endif %}
                    </span>
                    <!-- –ö–ù–û–ü–ö–ê –û–ó–í–£–ß–ö–ò - –î–û–ë–ê–í–õ–ï–ù–û -->
                    {% if not is_reverse %}
                    <button class="tts-btn" onclick="playWordAudio({{ user_word.word.id }})"
                            title="–û–∑–≤—É—á–∏—Ç—å —Å–ª–æ–≤–æ">
                        üîä
                    </button>
                    {% endif %}
                    {% if user_word.word.transcription and not is_reverse %}
                    <span class="word-transcription">[{{ user_word.word.transcription }}]</span>
                    {% endif %}
                </div>
            </div>

            <div class="transcription">
                {% if user_word.word.transcription and not is_reverse %}
                    –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: [{{ user_word.word.transcription }}]
                {% endif %}
            </div>

            <div class="answer" id="answer-{{ user_word.id }}">
                {% if is_reverse %}
                    {{ user_word.word.original }}
                {% else %}
                    {{ user_word.word.translation }}
                {% endif %}
            </div>

            <div class="action-buttons">
                <button class="btn show-btn" onclick="showAnswer({{ user_word.id }})">
                    üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
                </button>
                <button class="btn know-btn" onclick="submitAnswer({{ user_word.id }}, 'know')">
                    ‚úÖ –ó–Ω–∞—é
                </button>
                <button class="btn dont-know-btn" onclick="submitAnswer({{ user_word.id }}, 'dont_know')">
                    ‚ùå –ù–µ –∑–Ω–∞—é
                </button>
            </div>

            <div class="progress-info">
                –£—Ä–æ–≤–µ–Ω—å: {{ user_word.get_repetition_display }} |
                –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π: {{ user_word.repetition }} |
                –°–ª–µ–¥. –ø–æ–≤—Ç–æ—Ä: {{ user_word.next_review|date:"d.m.Y" }}
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="no-words">
        <h3>üéâ –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</h3>
        <p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è —Å–ª–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –Ω–µ—Ç.</p>
        <p>–ù–æ–≤—ã–µ —Å–ª–æ–≤–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–∞–≤—Ç—Ä–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º.</p>
    </div>
{% endif %}

<!-- –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤-–∫–∞—Ä—Ç–æ—á–µ–∫ -->
{% if user_words %}
    {% for user_word in user_words %}
        <div class="word-card">
            <!-- –í–æ–ø—Ä–æ—Å (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∂–∏–º–∞ —Ä–µ–≤–µ—Ä—Å–∞) -->
            <div class="question">
                {% if is_reverse %}
                    {{ user_word.word.translation }}
                {% else %}
                    {{ user_word.word.original }}
                    <!-- –ö–ù–û–ü–ö–ê –û–ó–í–£–ß–ö–ò - –î–û–ë–ê–í–õ–ï–ù–û -->
                    <button class="tts-btn" onclick="playWordAudio({{ user_word.word.id }})"
                            title="–û–∑–≤—É—á–∏—Ç—å —Å–ª–æ–≤–æ">
                        üîä
                    </button>
                {% endif %}
            </div>

            <!-- –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ) -->
            {% if user_word.word.transcription and not is_reverse %}
            <div class="transcription">
                [{{ user_word.word.transcription }}]
            </div>
            {% endif %}

            <!-- –û—Ç–≤–µ—Ç -->
            <div class="answer">
                {% if is_reverse %}
                    {{ user_word.word.original }}
                {% else %}
                    {{ user_word.word.translation }}
                {% endif %}
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="action-buttons">
                <button class="btn show-btn" onclick="toggleAnswer(this)">
                    üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥
                </button>
                <form method="post" action=".?word_id={{ user_word.id }}&action=know" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn know-btn">
                        ‚úÖ –ó–Ω–∞—é
                    </button>
                </form>
                <form method="post" action=".?word_id={{ user_word.id }}&action=dont_know" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn dont-know-btn">
                        ‚ùå –ù–µ –∑–Ω–∞—é
                    </button>
                </form>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ -->
            <div class="progress-info">
                –£—Ä–æ–≤–µ–Ω—å: {{ user_word.get_repetition_display }} |
                –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π: {{ user_word.repetition }} |
                –°–ª–µ–¥. –ø–æ–≤—Ç–æ—Ä: {{ user_word.next_review|date:"d.m.Y" }}
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="no-words">
        <h3>üéâ –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</h3>
        <p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è —Å–ª–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –Ω–µ—Ç.</p>
        <p>–ù–æ–≤—ã–µ —Å–ª–æ–≤–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–∞–≤—Ç—Ä–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º.</p>
    </div>
{% endif %}

<script>
function showAnswer(wordId) {
    document.getElementById('answer-' + wordId).style.display = 'block';
}

function submitAnswer(wordId, action) {
    window.location.href = `.?word_id=${wordId}&action=${action}`;
}

function toggleAnswer(button) {
    const answer = button.parentElement.parentElement.querySelector('.answer');
    if (answer.style.display === 'block') {
        answer.style.display = 'none';
        button.textContent = 'üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥';
    } else {
        answer.style.display = 'block';
        button.textContent = 'üôà –°–∫—Ä—ã—Ç—å –ø–µ—Ä–µ–≤–æ–¥';
    }
}

// –§–£–ù–ö–¶–ò–Ø –û–ó–í–£–ß–ö–ò - –î–û–ë–ê–í–õ–ï–ù–û
function playWordAudio(wordId) {
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.innerHTML = '‚è≥';
    button.disabled = true;

    fetch(`/generate-audio/${wordId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const audio = new Audio(data.audio_url);
                audio.play();
            } else {
                alert('–û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∫–∏: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ');
        })
        .finally(() => {
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
}
</script>
{% endblock %}